<html>

<head>
    <!-- <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script> -->
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase-messaging.js"></script>
    <script src="http://code.jquery.com/jquery-3.3.1.min.js"></script>

    <script type="text/javascript">
        // Initialize Firebase
        firebase.initializeApp({
            'messagingSenderId': '765081251786'
        });

        // Retrieve Firebase Messaging object.
        const messaging = firebase.messaging();

        messaging.requestPermission()
            .then(function () {
                console.log('Notification permission granted.');

                getToken();
            })
            .catch(function (err) {
                console.log('Unable to get permission to notify.', err);
            });

        // Callback fired if Instance ID token is updated.
        messaging.onTokenRefresh(function () {
            console.log('Token refreshed.');

            getToken();
        });

        function getToken() {
            // Get Instance ID token. Initially this makes a network call, once retrieved
            // subsequent calls to getToken will return from cache.
            messaging.getToken()
                .then(function (currentToken) {
                    if (currentToken) {
                        console.log(currentToken);
                        sendTokenToServer(currentToken);
                        // updateUIForPushEnabled(currentToken);
                    } else {
                        // Show permission request.
                        console.log('No Instance ID token available. Request permission to generate one.');
                        // Show permission UI.
                        // updateUIForPushPermissionRequired();
                        // setTokenSentToServer(false);
                    }
                })
                .catch(function (err) {
                    console.log('An error occurred while retrieving token. ', err);
                    // showToken('Error retrieving Instance ID token. ', err);
                    // setTokenSentToServer(false);
                });
        }

        function sendTokenToServer(token) {
            $.post("https://push.dev.beebee.com.br/api/v1/push/subscribe",
                {
                    userId: 25,
                    type: "Android",
                    token: token,
                    uuid: "TesteWeb666"
                })
                .done(data => {
                    console.log(data);
                });
        }

        // Handle incoming messages. Called when:
        // - a message is received while the app has focus
        // - the user clicks on an app notification created by a sevice worker
        //   `messaging.setBackgroundMessageHandler` handler.
        messaging.onMessage(function (payload) {
            console.log("Message received. Foreground: ", payload);
            // ...

            const notificationTitle = payload.data.title;
            const notificationOptions = {
                data: Object.assign({}, payload.data),
                tag: payload.data.notId,
                body: payload.data.message,
                icon: 'https://static.wixstatic.com/media/ce3118_d14b0993f9784b898868a00195eb7964~mv2.jpg/v1/fill/w_92,h_75,al_c,q_80,usm_0.66_1.00_0.01/ce3118_d14b0993f9784b898868a00195eb7964~mv2.webp'
            };

            var n = new Notification(notificationTitle, notificationOptions);
            n.onclick = onNotClick;
        });

        function onNotClick(event) {
            console.log('On notification click: ', event);
            event.target.close();
        }
    </script>
</head>

<body>

</body>

</html>